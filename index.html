<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WavyChatApp</title>
  <link rel="icon" type="image/x-icon" href="WavyChatApp.ico">
  <style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background-color: #f0f2f5;
      overflow: hidden;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–≤–æ–≥–æ —Å–∞–π–¥–±–∞—Ä–∞ (—Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) */
    .sidebar {
      width: 300px;
      background-color: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      color: #333;
      display: flex;
      flex-wrap: wrap; /* –î–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –ø–æ–ª—è */
      gap: 10px;
      align-items: center;
      position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª—é—Å-–º–µ–Ω—é */
    }
    
    .sidebar-header #usernameDisplay {
        font-weight: bold;
        flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
        font-size: 1.1em;
        color: #333;
        margin-right: 5px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏ –ø–ª—é—Å–∞ */
        display: flex; /* –î–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ –∏ —Ç–µ–∫—Å—Ç–∞ */
        align-items: center;
        gap: 8px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∞–≤–∞—Ç–∞—Ä–æ–º –∏ –∏–º–µ–Ω–µ–º */
    }
    .sidebar-header #usernameDisplay .user-avatar-small {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        object-fit: cover;
        background-color: #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: white;
        font-size: 0.9em;
    }

    .sidebar-header .plus-button {
        background: none;
        border: none;
        font-size: 1.8em; /* –ë–æ–ª—å—à–æ–π –ø–ª—é—Å */
        font-weight: bold;
        color: #0088cc;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1; /* –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
    }
    .sidebar-header .plus-button:hover {
        color: #006bb3;
    }


    .sidebar-header button {
        background-color: #0088cc;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .sidebar-header button:hover {
        background-color: #006bb3;
    }
    .sidebar-header .search-btn {
        background: none;
        border: none;
        color: #0088cc;
        cursor: pointer;
        font-size: 1.1em;
        margin-left: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
        padding: 0;
    }
    .sidebar-header .search-btn:hover {
        text-decoration: underline;
    }


    .chat-list {
      flex-grow: 1;
      padding: 0;
      list-style: none;
    }

    .chat-list-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .chat-list-item:hover {
      background-color: #f5f5f5;
    }

    .chat-list-item.active {
      background-color: #e0f2ff;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: white;
      font-size: 1.2em;
      margin-right: 10px;
      flex-shrink: 0;
      overflow: hidden; /* –î–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    }
    .avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .chat-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-name {
      font-weight: bold;
      color: #333;
    }

    .last-message {
      font-size: 0.9em;
      color: #777;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
    .main-chat-area {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background-color: #e0e5ea;
    }

    .chat-header {
      background-color: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      flex-shrink: 0;
      position: relative; /* –î–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
    }

    .chat-header .chat-info {
        margin-left: 10px;
        flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –º–µ—Å—Ç–æ */
    }

    /* NEW: –ö–Ω–æ–ø–∫–∞ "–û–ø—Ü–∏–∏ —á–∞—Ç–∞" */
    .chat-options-button {
        background: none;
        border: none;
        font-size: 1.8em;
        font-weight: bold;
        color: #0088cc;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        margin-left: 15px;
    }
    .chat-options-button:hover {
        color: #006bb3;
    }

    /* NEW: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –æ–ø—Ü–∏–π —á–∞—Ç–∞ */
    .chat-options-menu {
        display: none;
        position: absolute;
        top: 60px; /* –ü–æ–¥ –∫–Ω–æ–ø–∫–æ–π */
        right: 10px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
        z-index: 100;
        padding: 10px 0;
        min-width: 200px;
    }
    .chat-options-menu button {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        color: #333;
        font-size: 1em;
    }
    .chat-options-menu button:hover {
        background-color: #f0f2f5;
    }
    .chat-options-menu button.danger {
        color: red;
    }


    .chat-messages {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      display: flex;
      max-width: 70%;
      word-wrap: break-word;
      cursor: pointer; /* –î–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
    }

    .message.selected {
        outline: 2px solid #0088cc;
        border-radius: 15px;
        box-shadow: 0 0 5px rgba(0, 136, 204, 0.5);
    }

    .message-bubble {
      padding: 10px 15px;
      border-radius: 15px;
      position: relative;
    }

    .message.me {
      align-self: flex-end;
    }

    .message.me .message-bubble {
      background-color: #d0f0ff;
      color: #333;
      border-bottom-right-radius: 5px;
    }

    .message.other {
      align-self: flex-start;
    }

    .message.other .message-bubble {
      background-color: #fff;
      color: #333;
      border-bottom-left-radius: 5px;
    }

    .message-author {
      font-weight: bold;
      font-size: 0.9em;
      margin-bottom: 3px;
      color: #007bff;
    }
    .message.me .message-author {
        color: #0056b3;
    }

    .message-text {
      font-size: 1em;
    }

    .message-time {
      font-size: 0.75em;
      color: #999;
      margin-top: 5px;
      text-align: right;
      display: block;
    }

    /* NEW: Styles for multiple images/documents */
    .message-images, .message-documents {
        display: flex;
        flex-wrap: wrap;
        gap: 8px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞–º–∏ */
        margin-top: 5px;
    }
    .message-bubble .message-images img {
        /* max-width: 100%; */ /* –£–±–∏—Ä–∞–µ–º —ç—Ç–æ, —á—Ç–æ–±—ã –ø–æ–∑–≤–æ–ª–∏—Ç—å –≥–∏–±–∫–∏–π —Ä–∞–∑–º–µ—Ä */
        height: auto;
        max-height: 200px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ */
        border-radius: 8px;
        object-fit: cover;
        cursor: pointer;
        /* NEW: Responsive images within bubble */
        flex-basis: auto; /* Allow items to determine their own size */
        min-width: 50px; /* Minimum size */
    }
    /* –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–Ω–æ–≥–æ, –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –¥–ª—è –ø–ª–∏—Ç–∫–∏ */
    .message-images:has(img:nth-child(2)) img {
        max-width: calc(50% - 4px); /* –î–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä—è–¥ */
    }
    .message-images:has(img:nth-child(3)) img {
        max-width: calc(33.33% - 5.33px); /* –¢—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä—è–¥ */
    }
    .message-images:has(img:nth-child(4)) img {
        max-width: calc(33.33% - 5.33px); /* –ü—Ä–∏ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö —Ç–∞–∫–∂–µ 3 –≤ —Ä—è–¥, 4-–µ –Ω–∏–∂–µ */
    }
    /* –î–ª—è 4—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ 2x2 */
    .message-images:has(img:nth-child(4)):not(:has(img:nth-child(5))) img {
        max-width: calc(50% - 4px);
    }
    /* –ï—Å–ª–∏ –º–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏—Ö –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ */
    .message-images:has(img:nth-child(5)) img,
    .message-images:has(img:nth-child(6)) img {
        max-width: calc(33.33% - 5.33px);
    }


    .message-bubble .document-link {
        display: flex; /* Changed to flex for better icon+text alignment */
        align-items: center;
        padding: 8px;
        background-color: #e6f3ff;
        border-radius: 5px;
        text-decoration: none;
        color: #0088cc;
        font-weight: bold;
        word-break: break-all;
        margin-top: 5px;
        width: fit-content; /* Adjust width to content */
        max-width: 100%; /* Ensure it doesn't overflow */
        gap: 5px; /* Space between icon and text */
    }
    .message-bubble .document-link:hover {
        background-color: #d0eaff;
    }
    .message-bubble .document-link .file-icon {
        font-size: 1.2em; /* Icon size within link */
    }

    .message-media-separator {
        border-top: 1px solid rgba(0,0,0,0.1); /* –õ–µ–≥–∫–∞—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */
        margin-top: 8px;
        padding-top: 5px;
        display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è JS –µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Ç–µ–∫—Å—Ç –∏ –º–µ–¥–∏–∞ */
    }


    .chat-input-area {
      background-color: #fff;
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-shrink: 0;
      position: relative; /* –î–ª—è channel-specific-button */
    }

    .chat-input-area .input-row {
        display: flex;
        gap: 10px;
        width: 100%;
    }

    .chat-input-area input[type="text"] {
      flex-grow: 1;
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 1em;
    }

    .chat-input-area button {
      background-color: #0088cc;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .chat-input-area button:hover {
      background-color: #006bb3;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .image-upload-btn, .document-upload-btn {
        background-color: #f0f2f5;
        border: 1px solid #e0e0e0;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        color: #555;
        transition: background-color 0.2s ease;
        position: relative;
        overflow: hidden; /* –ß—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å input file */
    }
    .image-upload-btn:hover, .document-upload-btn:hover {
        background-color: #e0e0e0;
    }
    .image-upload-btn input[type="file"],
    .document-upload-btn input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }


    .delete-btn {
      position: absolute;
      top: 2px;
      right: 5px;
      cursor: pointer;
      color: red;
      font-weight: bold;
      font-size: 0.7em;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
      box-shadow: 0 0 3px rgba(0,0,0,0.2);
    }
    .message.me:hover .delete-btn { display: flex; }

    .settings-btn, .language-btn, .bot-btn {
        background: none;
        border: none;
        color: #0088cc;
        cursor: pointer;
        font-size: 1.1em;
        margin-left: 10px;
    }
    .settings-btn:hover, .language-btn:hover, .bot-btn:hover {
        text-decoration: underline;
    }
    
    /* –ù–û–í–û–ï: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ */
    #mediaPreviewContainer {
        display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        flex-wrap: wrap; /* –î–ª—è —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –≤ —Å—Ç—Ä–æ–∫—É */
        gap: 10px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –ø—Ä–µ–≤—å—é */
        margin-bottom: 10px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        overflow-x: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, –µ—Å–ª–∏ –º–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é */
    }
    .media-preview-item {
        position: relative;
        width: 90px; /* –†–∞–∑–º–µ—Ä –ø—Ä–µ–≤—å—é */
        height: 90px;
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã */
    }
    .media-preview-item.image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .media-preview-item.document-preview {
        flex-direction: column;
        font-size: 0.8em;
        color: #555;
        padding: 5px;
        box-sizing: border-box; /* –£—á–∏—Ç—ã–≤–∞—Ç—å padding –≤ —Ä–∞–∑–º–µ—Ä–∞—Ö */
        background-color: #e6f3ff;
    }
    .media-preview-item.document-preview .file-icon {
        font-size: 2em;
        color: #0088cc;
        margin-bottom: 2px;
    }
    .media-preview-item.document-preview .file-name {
        word-break: break-all;
        text-align: center;
        font-size: 0.7em;
        line-height: 1.2;
        max-height: 3.6em; /* –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å 3 —Å—Ç—Ä–æ–∫–∞–º–∏ */
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .remove-media-preview-individual { /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–≤—å—é */
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(0,0,0,0.6);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 0.7em;
        z-index: 10;
    }

    /* NEW: –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ */
    #channelComponentsBtn {
        position: absolute;
        bottom: 80px; /* –ù–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ */
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: #0088cc;
        color: white;
        border-radius: 50%;
        display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ */
        justify-content: center;
        align-items: center;
        font-size: 2em;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: background-color 0.2s ease;
        z-index: 50;
    }
    #channelComponentsBtn:hover {
        background-color: #006bb3;
    }


    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .modal-input-group {
        margin-bottom: 15px;
    }
    .modal-input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .modal-input-group input, .modal-input-group button {
        width: calc(100% - 20px);
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    .modal-input-group button {
        width: 100%;
        background-color: #0088cc;
        color: white;
        cursor: pointer;
    }
    .modal-input-group button:hover {
        background-color: #006bb3;
    }

    .search-results-list {
        list-style: none;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 5_px;
        margin-top: 10px;
    }
    .search-results-list li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .search-results-list li:last-child {
        border-bottom: none;
    }
    .search-results-list button {
        width: auto;
        padding: 5px 10px;
        font-size: 0.9em;
    }

    /* –ü–ª—é—Å-–º–µ–Ω—é (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ) */
    #plusMenuModal .modal-content button {
        display: block;
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 10px;
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1.1em;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    #plusMenuModal .modal-content button:hover {
        background-color: #e0e0e0;
    }

    /* –ú–µ–Ω—é —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .download-menu {
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 5px 0;
        border-radius: 5px;
        min-width: 150px;
    }

    .download-menu-item {
        padding: 8px 15px;
        cursor: pointer;
        white-space: nowrap;
    }

    .download-menu-item:hover {
        background-color: #f0f0f0;
    }

  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <span id="usernameDisplay"><span class="user-avatar-small">?</span> –ó–∞–≥—Ä—É–∑–∫–∞...</span>
    <button class="plus-button" onclick="openPlusMenuModal()">+</button>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>
  <ul id="chatList" class="chat-list">
    </ul>
</div>

<div class="main-chat-area">
  <div class="chat-header">
    <div class="avatar" id="currentChatAvatar" style="background-color: #007bff;">?</div>
    <div class="chat-info">
        <div class="chat-name" id="currentChatName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="last-message" id="currentChatType"></div>
    </div>
    <button class="language-btn" onclick="changeLanguage()">üåê –Ø–∑—ã–∫</button>
    <button class="bot-btn" onclick="showBots()">ü§ñ –ë–æ—Ç—ã</button>
    <button class="chat-options-button" id="chatOptionsButton" onclick="toggleChatOptionsMenu()">...</button>
    <div class="chat-options-menu" id="chatOptionsMenu">
        </div>
  </div>
  <div id="chatMessages" class="chat-messages">
    </div>
  <div class="chat-input-area">
    <div id="mediaPreviewContainer" class="input-row">
        </div>
    <div class="input-row">
        <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <label class="image-upload-btn chat-input-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
            üñºÔ∏è
            <input type="file" id="imageInput" accept="image/*" multiple /> </label>
        <label class="document-upload-btn chat-input-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç">
            üìé
            <input type="file" id="documentInput" multiple /> </label>
        <button onclick="sendMessage()">‚û§</button>
    </div>
    <button id="channelComponentsBtn" onclick="openChannelComponentsMenu()">+</button>
  </div>
</div>

<div id="plusMenuModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closePlusMenuModal()">&times;</span>
        <h2>–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—Ç—å?</h2>
        <button onclick="openCreateGroupModal()">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</button>
        <button onclick="openCreateChannelModal()">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª</button>
        <button onclick="openSearchModal()">–ù–∞–π—Ç–∏ / –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥—Ä—É–ø–ø—É –∏–ª–∏ –∫–∞–Ω–∞–ª</button>
    </div>
</div>

<div id="createGroupModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeCreateGroupModal()">&times;</span>
        <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É</h2>
        <div class="modal-input-group">
            <label for="newGroupNameInput">–ò–º—è –≥—Ä—É–ø–ø—ã:</label>
            <input type="text" id="newGroupNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        </div>
        <div class="modal-input-group">
            <label for="groupAvatarInput">–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã:</label>
            <input type="file" id="groupAvatarInput" accept="image/*">
        </div>
        <button onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>
</div>

<div id="createChannelModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeCreateChannelModal()">&times;</span>
        <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª</h2>
        <div class="modal-input-group">
            <label for="newChannelNameInput">–ò–º—è –∫–∞–Ω–∞–ª–∞:</label>
            <input type="text" id="newChannelNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
        </div>
        <div class="modal-input-group">
            <label for="channelAvatarInput">–ê–≤–∞—Ç–∞—Ä –∫–∞–Ω–∞–ª–∞:</label>
            <input type="file" id="channelAvatarInput" accept="image/*">
        </div>
        <button onclick="createChannel()">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
    </div>
</div>


<div id="searchModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeSearchModal()">&times;</span>
        <h2>–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≥—Ä—É–ø–ø, –∫–∞–Ω–∞–ª–æ–≤</h2>
        <div class="modal-input-group">
            <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø–æ–∏—Å–∫–∞...">
            <button onclick="performSearch()">–ò—Å–∫–∞—Ç—å</button>
        </div>
        <ul id="searchResults" class="search-results-list">
            </ul>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeSettingsModal()">&times;</span>
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="modal-input-group">
            <label for="settingUsername">–í–∞—à–µ –∏–º—è:</label>
            <input type="text" id="settingUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <button onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è</button>
        </div>
        <div class="modal-input-group">
            <label for="avatarUploadInput">–í–∞—à–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞:</label>
            <input type="file" id="avatarUploadInput" accept="image/*">
            <button onclick="uploadUserAvatar()">–ó–∞–≥—Ä—É–∑–∏—Ç—å/–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</button>
            <div id="currentAvatarPreview" class="avatar" style="margin-top: 10px;">?</div>
        </div>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDkddzOzJyOK4JfvGq7S6SD3usXaAGqBog",
    authDomain: "mymessenger-c1bde.firebaseapp.com",
    projectId: "mymessenger-c1bde",
    storageBucket: "mymessenger-c1bde.firebasestorage.app",
    messagingSenderId: "331583803279",
    appId: "1:331583803279:web:10a7a2186d583abdab05fa",
    measurementId: "G-WBT9D86V0W",
    databaseURL: "https://mymessenger-c1bde-default-rtdb.firebaseio.com"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
  const usernameDisplay = document.getElementById('usernameDisplay');
  const chatListElement = document.getElementById('chatList');
  const currentChatAvatar = document.getElementById('currentChatAvatar');
  const currentChatName = document.getElementById('currentChatName');
  const currentChatType = document.getElementById('currentChatType');
  const chatMessagesElement = document.getElementById('chatMessages');
  const messageInput = document.getElementById('messageInput');
  const imageInput = document.getElementById('imageInput');
  const documentInput = document.getElementById('documentInput');
  const mediaPreviewContainer = document.getElementById('mediaPreviewContainer'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–µ–≤—å—é
  const chatOptionsButton = document.getElementById('chatOptionsButton');
  const chatOptionsMenu = document.getElementById('chatOptionsMenu');
  const channelComponentsBtn = document.getElementById('channelComponentsBtn');


  // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  const plusMenuModal = document.getElementById('plusMenuModal');
  const createGroupModal = document.getElementById('createGroupModal');
  const newGroupNameInput = document.getElementById('newGroupNameInput');
  const groupAvatarInput = document.getElementById('groupAvatarInput'); // NEW
  const createChannelModal = document.getElementById('createChannelModal');
  const newChannelNameInput = document.getElementById('newChannelNameInput');
  const channelAvatarInput = document.getElementById('channelAvatarInput'); // NEW
  const searchModal = document.getElementById('searchModal');
  const searchInput = document.getElementById('searchInput');
  const searchResultsList = document.getElementById('searchResults');
  const settingsModal = document.getElementById('settingsModal');
  const settingUsernameInput = document.getElementById('settingUsername');
  const avatarUploadInput = document.getElementById('avatarUploadInput');
  const currentAvatarPreview = document.getElementById('currentAvatarPreview');

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —á–∞—Ç–∞
  let currentUser = null;
  let currentUserId = null;
  let currentUsername = null;
  let currentUserAvatarUrl = null;
  let currentChatId = null; // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ loadChatList
  let currentChatMode = null; // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ loadChatList
  let currentMessageListener = null;
  let selectedMessages = new Set();

  // NEW: –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –æ–∂–∏–¥–∞—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
  let pendingMediaFiles = [];

  // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–û–ú –ú–ù–û–ñ–ï–°–¢–í–ê –§–ê–ô–õ–û–í ---
  imageInput.onchange = (event) => {
      handleFileSelection(event.target.files, 'image');
      event.target.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
  };

  documentInput.onchange = (event) => {
      handleFileSelection(event.target.files, 'document');
      event.target.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å input
  };

  function handleFileSelection(files, type) {
      for (const file of files) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∏–º–µ–Ω–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
          if (!pendingMediaFiles.some(item => item.file.name === file.name && item.type === type)) {
              pendingMediaFiles.push({ file: file, type: type });
              addMediaPreview(file, type);
          }
      }
      showMediaPreviewContainer();
  }

  function addMediaPreview(file, type) {
      const previewItem = document.createElement('div');
      previewItem.className = 'media-preview-item';
      previewItem.dataset.fileName = file.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∫–∞–∫ ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      previewItem.dataset.fileType = type;

      if (type === 'image') {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          previewItem.appendChild(img);
          previewItem.classList.add('image-preview');
      } else { // document
          const icon = document.createElement('span');
          icon.className = 'file-icon';
          icon.textContent = 'üìÑ';
          const nameSpan = document.createElement('span');
          nameSpan.className = 'file-name';
          nameSpan.textContent = file.name;
          previewItem.appendChild(icon);
          previewItem.appendChild(nameSpan);
          previewItem.classList.add('document-preview');
      }

      const removeBtn = document.createElement('span');
      removeBtn.className = 'remove-media-preview-individual';
      removeBtn.textContent = '‚úï';
      removeBtn.onclick = () => {
          removeMediaFile(file.name, type); // –£–¥–∞–ª—è–µ–º –ø–æ –∏–º–µ–Ω–∏ –∏ —Ç–∏–ø—É
          previewItem.remove();
          if (pendingMediaFiles.length === 0) {
              hideMediaPreviewContainer();
          }
      };
      previewItem.appendChild(removeBtn);

      mediaPreviewContainer.appendChild(previewItem);
  }

  function removeMediaFile(fileNameToRemove, fileTypeToRemove) {
      pendingMediaFiles = pendingMediaFiles.filter(item => !(item.file.name === fileNameToRemove && item.type === fileTypeToRemove));
  }

  function showMediaPreviewContainer() {
      mediaPreviewContainer.style.display = 'flex';
  }

  function hideMediaPreviewContainer() {
      mediaPreviewContainer.style.display = 'none';
      mediaPreviewContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—ã
  }
  // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–û–ú ---

  // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –ü–û –î–í–û–ô–ù–û–ú–£ –ö–õ–ò–ö–£ ---
  let downloadMenu = null;

  function createDownloadMenu(event, imageUrl, imageData) {
      if (downloadMenu) {
          downloadMenu.remove();
      }

      downloadMenu = document.createElement('div');
      downloadMenu.className = 'download-menu';
      downloadMenu.style.position = 'absolute';
      downloadMenu.style.left = `${event.clientX}px`;
      downloadMenu.style.top = `${event.clientY}px`;

      const options = [
          { text: '–°–∫–∞—á–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª', action: 'original' },
          { text: '–°–∫–∞—á–∞—Ç—å –∫–∞–∫ PNG', action: 'png' },
          { text: '–°–∫–∞—á–∞—Ç—å –∫–∞–∫ JPEG', action: 'jpeg' }
      ];

      options.forEach(optionData => {
          const item = document.createElement('div');
          item.className = 'download-menu-item';
          item.textContent = optionData.text;
          item.onmouseover = () => item.style.backgroundColor = '#f0f0f0';
          item.onmouseout = () => item.style.backgroundColor = '';
          item.onclick = (e) => {
              e.stopPropagation();
              downloadImage(imageUrl, imageData, optionData.action);
              downloadMenu.remove();
              downloadMenu = null;
          };
          downloadMenu.appendChild(item);
      });

      document.body.appendChild(downloadMenu);
      document.addEventListener('click', closeDownloadMenu);
  }

  function closeDownloadMenu(event) {
      if (downloadMenu && !downloadMenu.contains(event.target)) {
          downloadMenu.remove();
          downloadMenu = null;
          document.removeEventListener('click', closeDownloadMenu);
      }
  }

  function downloadImage(originalUrl, base64Data, format) {
      const imageUrlToUse = base64Data || originalUrl;

      if (!imageUrlToUse) {
          console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
          alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');
          return;
      }

      const filenameBase = 'download';
      let filename = filenameBase;

      if (originalUrl) {
          const parts = originalUrl.split('/');
          const lastPart = parts[parts.length - 1];
          const nameWithoutQueryParams = lastPart.split('?')[0];
          const dotIndex = nameWithoutQueryParams.lastIndexOf('.');
          if (dotIndex > -1) {
              filename = nameWithoutQueryParams.substring(0, dotIndex);
          }
      }

      if (format === 'original' && originalUrl) {
          const link = document.createElement('a');
          link.href = originalUrl;
          link.download = filename + (originalUrl.match(/\.([a-z0-9]+)(?:[\?#]|$)/i)?.[1] || '.bin');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      } else if (format === 'original' && base64Data) {
          const link = document.createElement('a');
          link.href = base64Data;
          link.download = filename + '.png'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è base64
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      } else {
          const img = new Image();
          img.crossOrigin = 'Anonymous';
          img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);

              let newFilename = filename;
              let mimeType = '';

              if (format === 'png') {
                  mimeType = 'image/png';
                  newFilename += '.png';
              } else if (format === 'jpeg') {
                  mimeType = 'image/jpeg';
                  newFilename += '.jpeg';
              } else {
                  console.error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', format);
                  return;
              }

              canvas.toBlob((blob) => {
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.download = newFilename;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  URL.revokeObjectURL(link.href);
              }, mimeType, 0.9);
          };
          img.onerror = (error) => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:', error);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å CORS –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.');
          };
          img.src = imageUrlToUse;
      }
  }
  // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ---


  // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      currentUserId = user.uid;

      const userSnapshot = await db.ref('users/' + currentUserId).once('value');
      if (userSnapshot.exists()) {
        const userData = userSnapshot.val();
        currentUsername = userData.username;
        currentUserAvatarUrl = userData.avatarUrl || null;
        updateUsernameDisplay();
        settingUsernameInput.value = currentUsername;
        updateCurrentAvatarPreview(currentUserAvatarUrl);
      } else {
        console.error("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ë–î –¥–ª—è UID:", currentUserId);
        logout();
        return;
      }

      loadChatList(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å–Ω–∞—á–∞–ª–∞

      // –ó–∞—Ç–µ–º –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —á–∞—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('user')) {
        const userId = urlParams.get('user');
        const targetUserSnapshot = await db.ref('users/' + userId).once('value');
        if (targetUserSnapshot.exists()) {
          const targetUserData = targetUserSnapshot.val();
          const privateChatId = [currentUserId, userId].sort().join('_');
          selectChat('private_chat', privateChatId, targetUserData.username, targetUserData.avatarUrl || null);
        } else {
          console.warn('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ' + userId + ' –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞.');
          selectChat('group', 'general', '–û–±—â–∞—è –≥—Ä—É–ø–ø–∞'); // Fallback
        }
      } else if (urlParams.has('group')) {
        const groupId = urlParams.get('group');
        const groupSnapshot = await db.ref('groups/' + groupId).once('value');
        if (groupSnapshot.exists()) {
          const groupData = groupSnapshot.val();
          selectChat('group', groupId, groupData.name, groupData.avatarUrl || null);
        } else {
          console.warn('–ì—Ä—É–ø–ø–∞ —Å ID ' + groupId + ' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
          selectChat('group', 'general', '–û–±—â–∞—è –≥—Ä—É–ø–ø–∞'); // Fallback
        }
      } else if (urlParams.has('channel')) {
        const channelId = urlParams.get('channel');
        const channelSnapshot = await db.ref('channels/' + channelId).once('value');
        if (channelSnapshot.exists()) {
          const channelData = channelSnapshot.val();
          selectChat('channel', channelId, channelData.name, channelData.avatarUrl || null);
        } else {
          console.warn('–ö–∞–Ω–∞–ª —Å ID ' + channelId + ' –Ω–µ –Ω–∞–π–¥–µ–Ω.');
          selectChat('group', 'general', '–û–±—â–∞—è –≥—Ä—É–ø–ø–∞'); // Fallback
        }
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –≤—ã–±–∏—Ä–∞–µ–º "–û–±—â—É—é –≥—Ä—É–ø–ø—É"
        selectChat('group', 'general', '–û–±—â–∞—è –≥—Ä—É–ø–ø–∞');
      }

    } else {
      window.location.href = 'auth.html';
    }
  });

  function updateUsernameDisplay() {
    const avatarHtml = currentUserAvatarUrl ? `<img src="${currentUserAvatarUrl}" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar-small">` : `<span class="user-avatar-small" style="background-color: ${getColorForChat(currentUserId)};">${currentUsername.charAt(0).toUpperCase()}</span>`;
    usernameDisplay.innerHTML = `${avatarHtml} ${currentUsername}`;
  }

  function updateCurrentAvatarPreview(url) {
    if (url) {
      currentAvatarPreview.innerHTML = `<img src="${url}" alt="–ê–≤–∞—Ç–∞—Ä">`;
    } else {
      currentAvatarPreview.innerHTML = currentUsername.charAt(0).toUpperCase();
      currentAvatarPreview.style.backgroundColor = getColorForChat(currentUserId);
    }
  }

  function getColorForChat(id) {
    if (!id) return '#ccc';
    const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B'];
    let hash = 0;
    for (let i = 0; i < id.length; i++) {
      hash = id.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash % colors.length);
    return colors[index];
  }

  // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ê–¢–ê–ú–ò –ò UI ---

  async function selectChat(type, id, name, avatarUrl = null) {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –æ–ø—Ü–∏–π —á–∞—Ç–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —á–∞—Ç–∞
    chatOptionsMenu.style.display = 'none';

    currentChatMode = type;
    currentChatId = id;
    selectedMessages.clear();

    currentChatName.textContent = name;
    switch (type) {
      case 'user':
        currentChatType.textContent = '–õ–∏—á–Ω—ã–π —á–∞—Ç (–í—ã)';
        break;
      case 'private_chat':
        currentChatType.textContent = '–õ–∏—á–Ω—ã–π —á–∞—Ç';
        break;
      case 'group':
        currentChatType.textContent = '–ì—Ä—É–ø–ø–∞';
        break;
      case 'channel':
        currentChatType.textContent = '–ö–∞–Ω–∞–ª';
        break;
      case 'bot':
        currentChatType.textContent = '–ë–æ—Ç';
        break;
      default:
        currentChatType.textContent = '–ß–∞—Ç';
    }

    if (avatarUrl) {
      currentChatAvatar.innerHTML = `<img src="${avatarUrl}" alt="${name.charAt(0).toUpperCase()}">`;
    } else {
      currentChatAvatar.innerHTML = name.charAt(0).toUpperCase();
      currentChatAvatar.style.backgroundColor = getColorForChat(id);
    }

    // –í–∫–ª—é—á–∞–µ–º/–æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
    const isChannel = (type === 'channel');
    messageInput.disabled = isChannel;
    imageInput.disabled = isChannel;
    documentInput.disabled = isChannel;
    messageInput.placeholder = isChannel ? '–í –∫–∞–Ω–∞–ª–∞—Ö –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è' : '–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–∞–Ω–∞–ª–∞
    channelComponentsBtn.style.display = isChannel ? 'flex' : 'none';

    document.querySelectorAll('.chat-list-item').forEach(item => {
      item.classList.remove('active');
    });

    const selectedItem = document.querySelector(`.chat-list-item[data-type="${type}"][data-id="${id}"]`);
    if (selectedItem) {
      selectedItem.classList.add('active');
    }

    // –ï—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å, –æ—Ç–∫–ª—é—á–∞–µ–º –µ–≥–æ
    if (currentMessageListener) {
      currentMessageListener.off('child_added');
      currentMessageListener.off('child_removed');
      currentMessageListener = null;
    }

    chatMessagesElement.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è

    let messagesRef;
    if (type === 'group') {
      messagesRef = db.ref('chat_messages/group/' + id);
    } else if (type === 'channel') {
      messagesRef = db.ref('chat_messages/channel/' + id);
    } else if (type === 'private_chat') {
      messagesRef = db.ref('chat_messages/private_chat/' + id);
    } else if (type === 'user' && id === currentUserId) {
        messagesRef = db.ref('chat_messages/private_chat/' + [currentUserId, currentUserId].sort().join('_'));
    } else {
      console.error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞:", type);
      return;
    }

    currentMessageListener = messagesRef;
    messagesRef.limitToLast(50).on('child_added', (snapshot) => {
      const message = { id: snapshot.key, ...snapshot.val() };
      const isMe = message.senderId === currentUserId;
      displayMessage(message, isMe);
    }, (error) => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
    });

    messagesRef.on('child_removed', (snapshot) => {
        const removedMessageId = snapshot.key;
        const messageElement = chatMessagesElement.querySelector(`[data-message-id="${removedMessageId}"]`);
        if (messageElement) {
            messageElement.remove();
        }
    });

    const initialMessagesSnapshot = await messagesRef.limitToLast(50).once('value');
    initialMessagesSnapshot.forEach((childSnapshot) => {
        const message = { id: childSnapshot.key, ...childSnapshot.val() };
        const isMe = message.senderId === currentUserId;
        displayMessage(message, isMe, true);
    });
    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –æ–ø—Ü–∏–π —á–∞—Ç–∞
    updateChatOptionsMenu();
  }

  // NEW: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –º–µ–¥–∏–∞
  function displayMessage(message, isMe, prepend = false) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.classList.add(isMe ? 'me' : 'other');
    messageElement.dataset.messageId = message.id;

    const messageBubble = document.createElement('div');
    messageBubble.classList.add('message-bubble');

    let contentHtml = '';
    const hasText = message.text && message.text.trim() !== '';
    const hasImages = message.imageDatas && message.imageDatas.length > 0;
    const hasDocuments = message.documents && message.documents.length > 0;

    if (!isMe && currentChatMode !== 'private_chat' && message.senderId !== currentUserId) {
        contentHtml += `<div class="message-author">${message.senderName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>`;
    }

    if (hasText) {
        contentHtml += `<div class="message-text">${message.text}</div>`;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, –µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Ç–µ–∫—Å—Ç, –∏ –∫–∞–∫–∏–µ-–ª–∏–±–æ –º–µ–¥–∏–∞
    if (hasText && (hasImages || hasDocuments)) {
        contentHtml += `<div class="message-media-separator"></div>`;
    }

    if (hasImages) {
        contentHtml += `<div class="message-images">`;
        message.imageDatas.forEach(imageData => {
            // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ base64
            // –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ undefined –≤ ondbclick
            contentHtml += `<img src="${imageData}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" ondblclick="createDownloadMenu(event, '', '${imageData}')">`;
        });
        // NEW: –µ—Å–ª–∏ —Ç–∞–∫–∂–µ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ imageUrls (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        if (message.imageUrls && message.imageUrls.length > 0) {
            message.imageUrls.forEach(imageUrl => {
                 contentHtml += `<img src="${imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" ondblclick="createDownloadMenu(event, '${imageUrl}', '')">`;
            });
        }
        contentHtml += `</div>`;
    }

    if (hasDocuments) {
        contentHtml += `<div class="message-documents">`;
        message.documents.forEach(doc => {
            // docs.url —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –±—ã—Ç—å Base64
            contentHtml += `<a href="#" class="document-link" onclick="downloadDocument(event, '${doc.url}', '${doc.name}')">
                               <span class="file-icon">üìÑ</span> ${doc.name}
                           </a>`;
        });
        contentHtml += `</div>`;
    }

    contentHtml += `<span class="message-time">${new Date(message.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;

    if (isMe) {
        contentHtml += `<span class="delete-btn" onclick="deleteMessage('${message.id}')">‚úï</span>`;
    }

    messageBubble.innerHTML = contentHtml;
    messageElement.appendChild(messageBubble);

    messageElement.addEventListener('click', (event) => {
        if (!isMe) return;
        event.stopPropagation();
        toggleMessageSelection(message.id);
    });

    if (prepend) {
        chatMessagesElement.prepend(messageElement);
    } else {
        chatMessagesElement.appendChild(messageElement);
        chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
    }
  }

  // NEW: –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è sendMessage –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ (–î–û–ö–£–ú–ï–ù–¢–´ –¢–ï–ü–ï–†–¨ –ö–ê–ö BASE64)
  async function sendMessage() {
    const messageText = messageInput.value.trim();

    if (!messageText && pendingMediaFiles.length === 0) {
      alert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã.");
      return;
    }

    if (!currentUserId || !currentUsername) {
      alert("–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.");
      return;
    }

    let messageData = {
      senderId: currentUserId,
      senderName: currentUsername,
      time: firebase.database.ServerValue.TIMESTAMP
    };

    if (messageText) {
      messageData.text = messageText;
    }

    messageData.imageDatas = []; // –î–ª—è base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    messageData.documents = [];  // –î–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ {url(Base64), name} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

    const fileProcessingPromises = [];

    for (const mediaItem of pendingMediaFiles) {
        const file = mediaItem.file;
        const type = mediaItem.type;

        fileProcessingPromises.push(new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'image') {
                    messageData.imageDatas.push(e.target.result); // –î–æ–±–∞–≤–ª—è–µ–º base64 –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                } else if (type === 'document') {
                    // –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º Base64 –∏ –∏–º—è —Ñ–∞–π–ª–∞
                    messageData.documents.push({ url: e.target.result, name: file.name });
                }
                resolve();
            };
            reader.onerror = (error) => {
                console.error(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ${file.name}:`, error);
                reject(new Error(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ${file.name}: ${error.message}`));
            };
            reader.readAsDataURL(file); // –ß–∏—Ç–∞–µ–º –∫–∞–∫ DataURL (Base64) –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
        }));
    }

    try {
        await Promise.all(fileProcessingPromises); // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏

        // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        saveMessageToDb(messageData);

        // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        pendingMediaFiles = [];
        hideMediaPreviewContainer();
        messageInput.value = '';
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: " + error.message);
        // –ù–µ –æ—á–∏—â–∞–µ–º pendingMediaFiles, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
        // –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é
    }
  }


  function saveMessageToDb(messageData) {
      let messagesRef;
      if (currentChatMode === 'group') {
          messagesRef = db.ref('chat_messages/group/' + currentChatId);
      } else if (currentChatMode === 'channel') {
          messagesRef = db.ref('chat_messages/channel/' + currentChatId);
      } else if (currentChatMode === 'private_chat') {
          messagesRef = db.ref('chat_messages/private_chat/' + currentChatId);
          // NEW: –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
          // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª–µ–º –Ω–∞ `db.ref('users')` –≤ `loadChatList`
          // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —É–∑–µ–ª `user_chats/<uid>/<partner_uid>`
          // –ù–æ –¥–ª—è —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –±—É–¥–µ–º –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ `loadChatList`
      } else {
          console.error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º —á–∞—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:", currentChatMode);
          return;
      }
      messagesRef.push(messageData)
          .then(() => console.log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"))
          .catch(error => console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error));
  }

  function deleteMessage(messageId) {
      if (!currentUserId) {
          alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.");
          return;
      }

      let messagePath;
      if (currentChatMode === 'group') {
          messagePath = `chat_messages/group/${currentChatId}/${messageId}`;
      } else if (currentChatMode === 'channel') {
          messagePath = `chat_messages/channel/${currentChatId}/${messageId}`;
      } else if (currentChatMode === 'private_chat') {
          messagePath = `chat_messages/private_chat/${currentChatId}/${messageId}`;
      } else {
          alert("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —ç—Ç–æ–º —Ç–∏–ø–µ —á–∞—Ç–∞.");
          return;
      }

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      db.ref(messagePath).once('value', (snapshot) => {
          const message = snapshot.val();
          if (message && message.senderId === currentUserId) {
              if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                  db.ref(messagePath).remove()
                      .then(() => {
                          console.log("–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ.");
                          // UI –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è —Å–ª—É—à–∞—Ç–µ–ª—é 'child_removed'
                      })
                      .catch(error => {
                          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: " + error.message);
                      });
              }
          } else {
              alert("–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è.");
          }
      });
  }

  // NEW: –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Ç–µ–ø–µ—Ä—å —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å Base64)
  function downloadDocument(event, url, name) {
      event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
      if (url.startsWith('data:')) {
          // –ï—Å–ª–∏ —ç—Ç–æ Base64, —Å–æ–∑–¥–∞–µ–º Blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º
          const link = document.createElement('a');
          link.href = url;
          link.download = name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href); // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL
      } else {
          // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π URL –∏–∑ Storage, —Å–∫–∞—á–∏–≤–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
          const link = document.createElement('a');
          link.href = url;
          link.download = name;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      }
  }

  function toggleMessageSelection(messageId) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageElement) return;

      if (selectedMessages.has(messageId)) {
          selectedMessages.delete(messageId);
          messageElement.classList.remove('selected');
      } else {
          selectedMessages.add(messageId);
          messageElement.classList.add('selected');
      }

      // console.log("–í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", Array.from(selectedMessages));
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  }

  // --- –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –°–ü–ò–°–ö–ê –ß–ê–¢–û–í (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≥—Ä—É–ø–ø, –∫–∞–Ω–∞–ª–æ–≤) ---
  async function loadChatList() {
    chatListElement.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ (–ª–∏—á–Ω—ã–π —á–∞—Ç —Å —Å–æ–±–æ–π)
    const selfChatAvatar = currentUserAvatarUrl ? `<img src="${currentUserAvatarUrl}" alt="–ê–≤–∞—Ç–∞—Ä">` : `${currentUsername.charAt(0).toUpperCase()}`;
    const selfChatBgColor = currentUserAvatarUrl ? '' : `background-color: ${getColorForChat(currentUserId)};`;

    const selfChatItem = document.createElement('li');
    selfChatItem.classList.add('chat-list-item');
    selfChatItem.dataset.type = 'user';
    selfChatItem.dataset.id = currentUserId;
    selfChatItem.onclick = () => selectChat('user', currentUserId, currentUsername, currentUserAvatarUrl);
    selfChatItem.innerHTML = `
        <div class="avatar" style="${selfChatBgColor}">${selfChatAvatar}</div>
        <div class="chat-info">
            <div class="chat-name">${currentUsername} (–í—ã)</div>
            <div class="last-message">–õ–∏—á–Ω—ã–π —á–∞—Ç</div>
        </div>
    `;
    chatListElement.appendChild(selfChatItem);


    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã (–≤–∫–ª—é—á–∞—è "general", –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    db.ref('groups').on('value', (snapshot) => {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        document.querySelectorAll('.chat-list-item[data-type="group"]').forEach(item => item.remove());

        snapshot.forEach((childSnapshot) => {
            const group = childSnapshot.val();
            const groupId = childSnapshot.key;
            
            const listItem = document.createElement('li');
            listItem.classList.add('chat-list-item');
            listItem.dataset.type = 'group';
            listItem.dataset.id = groupId;
            listItem.onclick = () => selectChat('group', groupId, group.name, group.avatarUrl || null);

            const avatarHtml = group.avatarUrl ? `<img src="${group.avatarUrl}" alt="${group.name.charAt(0).toUpperCase()}">` : group.name.charAt(0).toUpperCase();
            const avatarBgColor = group.avatarUrl ? '' : `background-color: ${getColorForChat(groupId)};`;

            listItem.innerHTML = `
                <div class="avatar" style="${avatarBgColor}">${avatarHtml}</div>
                <div class="chat-info">
                    <div class="chat-name">${group.name}</div>
                    <div class="last-message">–ì—Ä—É–ø–ø–∞</div>
                </div>
            `;
            chatListElement.appendChild(listItem);
        });
    });


    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã
    db.ref('channels').on('value', (snapshot) => {
        document.querySelectorAll('.chat-list-item[data-type="channel"]').forEach(item => item.remove());

        snapshot.forEach((childSnapshot) => {
            const channel = childSnapshot.val();
            const channelId = childSnapshot.key;

            const listItem = document.createElement('li');
            listItem.classList.add('chat-list-item');
            listItem.dataset.type = 'channel';
            listItem.dataset.id = channelId;
            listItem.onclick = () => selectChat('channel', channelId, channel.name, channel.avatarUrl || null);

            const avatarHtml = channel.avatarUrl ? `<img src="${channel.avatarUrl}" alt="${channel.name.charAt(0).toUpperCase()}">` : channel.name.charAt(0).toUpperCase();
            const avatarBgColor = channel.avatarUrl ? '' : `background-color: ${getColorForChat(channelId)};`;

            listItem.innerHTML = `
                <div class="avatar" style="${avatarBgColor}">${avatarHtml}</div>
                <div class="chat-info">
                    <div class="chat-name">${channel.name}</div>
                    <div class="last-message">–ö–∞–Ω–∞–ª</div>
                </div>
            `;
            chatListElement.appendChild(listItem);
        });
    });


    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    db.ref('users').on('value', (snapshot) => {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã, –∫—Ä–æ–º–µ "—Å–µ–±—è", —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        document.querySelectorAll('.chat-list-item[data-type="private_chat"]').forEach(item => item.remove());

        snapshot.forEach((childSnapshot) => {
            const user = childSnapshot.val();
            const userId = childSnapshot.key;

            if (userId === currentUserId) return; // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫

            // ID –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö UID –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const privateChatId = [currentUserId, userId].sort().join('_');

            const listItem = document.createElement('li');
            listItem.classList.add('chat-list-item');
            listItem.dataset.type = 'private_chat';
            listItem.dataset.id = privateChatId;
            listItem.onclick = () => selectChat('private_chat', listItem.dataset.id, user.username, user.avatarUrl || null);

            const avatarHtml = user.avatarUrl ? `<img src="${user.avatarUrl}" alt="${user.username.charAt(0).toUpperCase()}">` : user.username.charAt(0).toUpperCase();
            const avatarBgColor = user.avatarUrl ? '' : `background-color: ${getColorForChat(userId)};`;

            listItem.innerHTML = `
                <div class="avatar" style="${avatarBgColor}">${avatarHtml}</div>
                <div class="chat-info">
                    <div class="chat-name">${user.username}</div>
                    <div class="last-message">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                </div>
            `;
            chatListElement.appendChild(listItem);
        });
    });
  }


  // --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ---
  function openPlusMenuModal() { plusMenuModal.style.display = 'flex'; }
  function closePlusMenuModal() { plusMenuModal.style.display = 'none'; }

  function openCreateGroupModal() {
    closePlusMenuModal();
    newGroupNameInput.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
    groupAvatarInput.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    createGroupModal.style.display = 'flex';
  }
  function closeCreateGroupModal() { createGroupModal.style.display = 'none'; }

  async function createGroup() {
    const groupName = newGroupNameInput.value.trim();
    const groupAvatarFile = groupAvatarInput.files[0];

    if (!groupName) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã.');
      return;
    }
    if (!currentUser) {
      alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.');
      return;
    }

    let avatarUrl = null;
    if (groupAvatarFile) {
        if (!groupAvatarFile.type.startsWith('image/')) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ –≥—Ä—É–ø–ø—ã.");
            return;
        }
        try {
            const filePath = `group_avatars/${Date.now()}_${groupAvatarFile.name}`;
            const uploadTask = storage.ref().child(filePath).put(groupAvatarFile);
            await uploadTask; // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            avatarUrl = await uploadTask.ref.getDownloadURL();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –≥—Ä—É–ø–ø—ã:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –≥—Ä—É–ø–ø—ã: " + error.message);
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        }
    }

    try {
        const newGroupRef = db.ref('groups').push();
        await newGroupRef.set({
            name: groupName,
            name_lower: groupName.toLowerCase(), // –î–ª—è –ø–æ–∏—Å–∫–∞
            creatorId: currentUser.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            avatarUrl: avatarUrl // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∫–∏
        });
        alert(`–ì—Ä—É–ø–ø–∞ "${groupName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
        closeCreateGroupModal();
        selectChat('group', newGroupRef.key, groupName, avatarUrl); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã: " + error.message);
    }
  }

  function openCreateChannelModal() {
    closePlusMenuModal();
    newChannelNameInput.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
    channelAvatarInput.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    createChannelModal.style.display = 'flex';
  }
  function closeCreateChannelModal() { createChannelModal.style.display = 'none'; }

  async function createChannel() {
    const channelName = newChannelNameInput.value.trim();
    const channelAvatarFile = channelAvatarInput.files[0];

    if (!channelName) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞.');
      return;
    }
    if (!currentUser) {
      alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.');
      return;
    }

    let avatarUrl = null;
    if (channelAvatarFile) {
        if (!channelAvatarFile.type.startsWith('image/')) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞.");
            return;
        }
        try {
            const filePath = `channel_avatars/${Date.now()}_${channelAvatarFile.name}`;
            const uploadTask = storage.ref().child(filePath).put(channelAvatarFile);
            await uploadTask; // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            avatarUrl = await uploadTask.ref.getDownloadURL();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞: " + error.message);
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞, –µ—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
        }
    }

    try {
        const newChannelRef = db.ref('channels').push();
        await newChannelRef.set({
            name: channelName,
            name_lower: channelName.toLowerCase(), // –î–ª—è –ø–æ–∏—Å–∫–∞
            creatorId: currentUser.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            avatarUrl: avatarUrl // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∞–≤–∞—Ç–∞—Ä–∫–∏
        });
        alert(`–ö–∞–Ω–∞–ª "${channelName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);
        closeCreateChannelModal();
        selectChat('channel', newChannelRef.key, channelName, avatarUrl); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞: " + error.message);
    }
  }


  function openSearchModal() {
    closePlusMenuModal();
    searchInput.value = '';
    searchResultsList.innerHTML = '';
    searchModal.style.display = 'flex';
  }
  function closeSearchModal() { searchModal.style.display = 'none'; }

  async function performSearch() {
    const query = searchInput.value.trim().toLowerCase();
    searchResultsList.innerHTML = '';

    if (query.length < 2) {
      searchResultsList.innerHTML = '<li>–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.</li>';
      return;
    }

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const usersSnapshot = await db.ref('users').orderByChild('username_lower').startAt(query).endAt(query + '\uf8ff').once('value');
    usersSnapshot.forEach((childSnapshot) => {
      const user = childSnapshot.val();
      const userId = childSnapshot.key;
      if (userId === currentUserId) return; // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ –ø–æ–∏—Å–∫

      const listItem = document.createElement('li');
      listItem.innerHTML = `
        <span>${user.username} (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)</span>
        <button onclick="selectChatFromSearch('private_chat', '${userId}', '${user.username}', '${user.avatarUrl || ''}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
      `;
      searchResultsList.appendChild(listItem);
    });

    // –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø
    const groupsSnapshot = await db.ref('groups').orderByChild('name_lower').startAt(query).endAt(query + '\uf8ff').once('value');
    groupsSnapshot.forEach((childSnapshot) => {
      const group = childSnapshot.val();
      const groupId = childSnapshot.key;

      const listItem = document.createElement('li');
      listItem.innerHTML = `
        <span>${group.name} (–ì—Ä—É–ø–ø–∞)</span>
        <button onclick="selectChatFromSearch('group', '${groupId}', '${group.name}', '${group.avatarUrl || ''}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
      `;
      searchResultsList.appendChild(listItem);
    });

    // –ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤
    const channelsSnapshot = await db.ref('channels').orderByChild('name_lower').startAt(query).endAt(query + '\uf8ff').once('value');
    channelsSnapshot.forEach((childSnapshot) => {
      const channel = childSnapshot.val();
      const channelId = childSnapshot.key;

      const listItem = document.createElement('li');
      listItem.innerHTML = `
        <span>${channel.name} (–ö–∞–Ω–∞–ª)</span>
        <button onclick="selectChatFromSearch('channel', '${channelId}', '${channel.name}', '${channel.avatarUrl || ''}')">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
      `;
      searchResultsList.appendChild(listItem);
    });

    if (searchResultsList.children.length === 0) {
      searchResultsList.innerHTML = '<li>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</li>';
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
  async function selectChatFromSearch(type, id, name, avatarUrl) {
      closeSearchModal();

      let targetId = id; // –î–ª—è –≥—Ä—É–ø–ø/–∫–∞–Ω–∞–ª–æ–≤ ID —Å–æ–≤–ø–∞–¥–∞–µ—Ç
      if (type === 'private_chat') {
          // –î–ª—è –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞ ID —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –¥–≤—É—Ö UID
          targetId = [currentUserId, id].sort().join('_');
      }
      await selectChat(type, targetId, name, avatarUrl || null);

      // –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞, loadChatList –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫.
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å.
      const selectedItem = document.querySelector(`.chat-list-item[data-type="${type}"][data-id="${targetId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
  }


  function openSettings() {
    settingUsernameInput.value = currentUsername;
    updateCurrentAvatarPreview(currentUserAvatarUrl);
    settingsModal.style.display = 'flex';
  }
  function closeSettingsModal() { settingsModal.style.display = 'none'; }

  async function saveSettings() {
      const newUsername = settingUsernameInput.value.trim();
      if (!newUsername) {
          alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
          return;
      }
      if (newUsername === currentUsername) {
          alert("–ò–º—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.");
          return;
      }

      try {
          await db.ref('users/' + currentUserId).update({
              username: newUsername,
              username_lower: newUsername.toLowerCase() // –î–ª—è –ø–æ–∏—Å–∫–∞
          });
          currentUsername = newUsername; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
          updateUsernameDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          alert("–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
      } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + error.message);
      }
  }

  async function uploadUserAvatar() {
      const file = avatarUploadInput.files[0];
      if (!file) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
          return;
      }

      if (!file.type.startsWith('image/')) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPEG, PNG, GIF).");
          return;
      }

      try {
          const filePath = `avatars/${currentUserId}/${file.name}`;
          const uploadTask = storage.ref().child(filePath).put(file);

          uploadTask.on('state_changed',
              (snapshot) => {
                  const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏: ' + progress.toFixed(2) + '%');
              },
              (error) => {
                  console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:', error);
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏: ' + error.message);
              },
              async () => {
                  const downloadURL = await uploadTask.ref.getDownloadURL();
                  
                  await db.ref('users/' + currentUserId + '/avatarUrl').set(downloadURL);
                  currentUserAvatarUrl = downloadURL;
                  
                  updateUsernameDisplay();
                  updateCurrentAvatarPreview(currentUserAvatarUrl);

                  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —Å–≤–æ–µ–º –ª–∏—á–Ω–æ–º —á–∞—Ç–µ –≤ —Å–ø–∏—Å–∫–µ, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                  const selfChatAvatarInList = document.querySelector(`.chat-list-item[data-type="user"][data-id="${currentUserId}"] .avatar`);
                  if (selfChatAvatarInList) {
                      selfChatAvatarInList.innerHTML = `<img src="${downloadURL}" alt="–ê–≤–∞—Ç–∞—Ä">`;
                  }
                  // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏–º –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ —á–∞—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ —á–∞—Ç —Å —Å–æ–±–æ–π
                  if (currentChatMode === 'user' && currentChatId === currentUserId) {
                      currentChatAvatar.innerHTML = `<img src="${downloadURL}" alt="–ê–≤–∞—Ç–∞—Ä">`;
                  }


                  alert("–ê–≤–∞—Ç–∞—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
              }
          );
      } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏:", error);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏: " + error.message);
      }
  }


  // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –û–ü–¶–ò–Ø–ú–ò –ß–ê–¢–ê (–í–´–•–û–î/–°–ö–†–´–¢–ò–ï) ---
  function toggleChatOptionsMenu() {
      const isVisible = chatOptionsMenu.style.display === 'block';
      chatOptionsMenu.style.display = isVisible ? 'none' : 'block';
  }

  function updateChatOptionsMenu() {
      chatOptionsMenu.innerHTML = ''; // –û—á–∏—â–∞–µ–º –º–µ–Ω—é

      // –õ–∏—á–Ω—ã–π —á–∞—Ç —Å —Å–æ–±–æ–π
      if (currentChatMode === 'user') {
          chatOptionsMenu.style.display = 'none'; // –ù–µ—Ç –æ–ø—Ü–∏–π –¥–ª—è —Å–µ–±—è
          return;
      }
      
      // –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞
      if (currentChatMode === 'private_chat') {
          const hideButton = document.createElement('button');
          hideButton.textContent = '–°–∫—Ä—ã—Ç—å —á–∞—Ç';
          hideButton.classList.add('danger');
          hideButton.onclick = () => {
              if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞.')) {
                  hidePrivateChat(currentChatId);
              }
              toggleChatOptionsMenu();
          };
          chatOptionsMenu.appendChild(hideButton);
      } 
      // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª–∞
      else if (currentChatMode === 'group' || currentChatMode === 'channel') {
          const leaveButton = document.createElement('button');
          leaveButton.textContent = `–í—ã–π—Ç–∏ –∏–∑ ${currentChatMode === 'group' ? '–≥—Ä—É–ø–ø—ã' : '–∫–∞–Ω–∞–ª–∞'}`;
          leaveButton.classList.add('danger');
          leaveButton.onclick = () => {
              if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —ç—Ç–æ–≥–æ ${currentChatMode === 'group' ? '–≥—Ä—É–ø–ø—ã' : '–∫–∞–Ω–∞–ª–∞'}?`)) {
                  leaveGroupOrChannel(currentChatId, currentChatMode);
              }
              toggleChatOptionsMenu();
          };
          chatOptionsMenu.appendChild(leaveButton);
      }

      // –ï—Å–ª–∏ –æ–ø—Ü–∏–∏ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–ø—Ü–∏–π
      chatOptionsButton.style.display = chatOptionsMenu.children.length > 0 ? 'flex' : 'none';
  }

  function hidePrivateChat(chatIdToHide) {
      // –î–ª—è "—Å–∫—Ä—ã—Ç–∏—è" –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞, –º—ã –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ UI —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
      // –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–±—â–∏–π —á–∞—Ç (–∏–ª–∏ –¥—Ä—É–≥–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π)
      const chatItem = document.querySelector(`.chat-list-item[data-type="private_chat"][data-id="${chatIdToHide}"]`);
      if (chatItem) {
          chatItem.remove();
          alert('–ß–∞—Ç —Å–∫—Ä—ã—Ç –∏–∑ —Å–ø–∏—Å–∫–∞.');
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ "–û–±—â—É—é –≥—Ä—É–ø–ø—É" –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —á–∞—Ç
          selectChat('group', 'general', '–û–±—â–∞—è –≥—Ä—É–ø–ø–∞');
      }
  }

  async function leaveGroupOrChannel(id, type) {
      try {
          if (type === 'group') {
              // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
              // –ù–∞–ø—Ä–∏–º–µ—Ä: db.ref(`group_members/${id}/${currentUserId}`).remove();
              // –ù–æ –ø–æ—Å–∫–æ–ª—å–∫—É —É –Ω–∞—Å –Ω–µ—Ç —Å–ø–∏—Å–∫–∞ —á–ª–µ–Ω–æ–≤, –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∏–∑ UI
              const chatItem = document.querySelector(`.chat-list-item[data-type="group"][data-id="${id}"]`);
              if (chatItem) {
                  chatItem.remove();
                  alert(`–í—ã –≤—ã—à–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã "${currentChatName.textContent}".`);
              }
          } else if (type === 'channel') {
              // –¢–æ –∂–µ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
              const chatItem = document.querySelector(`.chat-list-item[data-type="channel"][data-id="${id}"]`);
              if (chatItem) {
                  chatItem.remove();
                  alert(`–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞ "${currentChatName.textContent}".`);
              }
          }
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ "–û–±—â—É—é –≥—Ä—É–ø–ø—É" –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —á–∞—Ç
          selectChat('group', 'general', '–û–±—â–∞—è –≥—Ä—É–ø–ø–∞');
      } catch (error) {
          console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ ${type}:`, error);
          alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏ –∏–∑ ${type}: ${error.message}`);
      }
  }

  // NEW: –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–µ–Ω—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–∞–Ω–∞–ª–∞
  function openChannelComponentsMenu() {
      alert("–ú–µ–Ω—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–∞–Ω–∞–ª–∞ (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Ç.–¥.) - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!");
  }


  // --- –ü–†–û–ß–ò–ï –§–£–ù–ö–¶–ò–ò (–ó–ê–ì–õ–£–®–ö–ò) ---

  function changeLanguage() {
    alert("–°–º–µ–Ω–∞ —è–∑—ã–∫–∞ (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)");
  }

  function showBots() {
    alert("–°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤ (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)");
  }

  function logout() {
    auth.signOut().then(() => {
      console.log("–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.");
      window.location.href = 'auth.html';
    }).catch((error) => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:", error);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: " + error.message);
    });
  }

  // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –æ–ø—Ü–∏–π —á–∞—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', (event) => {
      if (chatOptionsMenu.style.display === 'block' && !chatOptionsMenu.contains(event.target) && event.target !== chatOptionsButton) {
          chatOptionsMenu.style.display = 'none';
      }
  });

</script>
</body>
</html>